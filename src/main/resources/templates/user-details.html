<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>User Details - Aleksandria</title>
  <link rel="stylesheet" th:href="@{/css/style.css}" />
</head>
<body>

<header>
  <h1><a th:href="@{/}" class="logo">Aleksandria Library</a></h1>
  <div class="user-menu">
    <span><strong sec:authentication="name">User</strong></span>
    <a th:href="@{/users/list}" class="btn btn-sm btn-light">Back to List</a>
  </div>
</header>

<div class="container">

  <div th:if="${successMessage}"
       style="background-color: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 1px solid #c3e6cb;">
    <span th:text="${successMessage}">Success!</span>
  </div>
  <div th:if="${errorMessage}"
       style="background-color: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 1px solid #f5c6cb;">
    <span th:text="${errorMessage}">Error!</span>
  </div>

  <div class="card">
    <div class="flex-between">
      <h2>User Details</h2>
      <span class="badge" th:classappend="'role-' + ${user.role.name}" th:text="${user.role.name}">ROLE</span>
    </div>
    <div class="info-grid">
      <span class="label">Full Name:</span>
      <span th:text="${user.firstName} + ' ' + ${user.lastName}">John Doe</span>
      <span class="label">Email:</span>
      <span th:text="${user.email}">email@example.com</span>
      <span class="label">Address:</span>
      <span th:text="${user.address}">Street 1</span>
      <span class="label">User ID:</span>
      <span th:text="${user.id}">1</span>
    </div>
  </div>

  <div class="card" th:if="${user.role.name == 'reader'}">
    <h3>Active Rentals</h3>

    <div th:with="activeRentals=${rentals.?[returnedOn == null]}">

      <div th:if="${activeRentals.empty}" class="text-muted">
        <p>No active rentals at the moment.</p>
      </div>

      <table th:if="${!activeRentals.empty}">
        <thead>
        <tr>
          <th>Book Title</th>
          <th>Copy ID</th>
          <th>Rented On</th>
          <th>Due Date</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="rental : ${activeRentals}">
          <td>
            <a th:href="@{/titles/view/{id}(id=${rental.book.title.id})}"
               th:text="${rental.book.title.titleName}"
               style="font-weight: bold; color: #007bff; text-decoration: none;">Title</a>
          </td>
          <td th:text="${rental.book.itemId}">10</td>
          <td th:text="${rental.rentedOn}">2023-01-01</td>
          <td th:text="${rental.due}"
              th:style="${rental.due.isBefore(#temporals.createToday())} ? 'color: red; font-weight: bold;' : ''">
            2023-01-14
          </td>
          <td>
            <span th:if="${rental.due.isBefore(#temporals.createToday())}" style="color: red; font-weight:bold;">OVERDUE</span>
            <span th:unless="${rental.due.isBefore(#temporals.createToday())}" style="color: green;">Active</span>
          </td>
          <td style="display:flex; gap: 5px;">
            <form th:action="@{/rentals/web/return}" method="post" onsubmit="return confirm('Confirm return?');">
              <input type="hidden" name="rentalId" th:value="${rental.id}" />
              <input type="hidden" name="userId" th:value="${user.id}" />
              <button type="submit" class="btn btn-success btn-sm">Return</button>
            </form>

            <form th:action="@{/rentals/web/extend}" method="post">
              <input type="hidden" name="rentalId" th:value="${rental.id}" />
              <input type="hidden" name="userId" th:value="${user.id}" />
              <button type="submit" class="btn btn-warning btn-sm" title="Extend by 14 days">+14 Days</button>
            </form>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="card" th:if="${user.role.name == 'reader'}">
    <h3>Rental History</h3>

    <div th:with="historyRentals=${rentals.?[returnedOn != null]}">

      <div th:if="${historyRentals.empty}" class="text-muted">
        <p>No past rental history.</p>
      </div>

      <table th:if="${!historyRentals.empty}">
        <thead>
        <tr>
          <th>Book Title</th>
          <th>Copy ID</th>
          <th>Rented On</th>
          <th>Returned On</th>
          <th>Fee</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="rental : ${historyRentals}">
          <td>
            <a th:href="@{/titles/view/{id}(id=${rental.book.title.id})}"
               th:text="${rental.book.title.titleName}"
               style="color: #555; text-decoration: none;">Title</a>
          </td>
          <td th:text="${rental.book.itemId}">10</td>
          <td th:text="${rental.rentedOn}">2023-01-01</td>
          <td th:text="${rental.returnedOn}">2023-01-15</td>
          <td>
            <span th:if="${rental.fee > 0}" th:text="${rental.fee} + ' PLN'" style="color: red;">0.0</span>
            <span th:if="${rental.fee == 0}" style="color: green;">-</span>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="card" th:if="${user.role.name == 'reader'}">
    <h3>Queue Status</h3>

    <div th:if="${queueEntries == null or queueEntries.empty}" class="text-muted">
      <p>This user is not currently waiting for any books.</p>
    </div>

    <table th:if="${queueEntries != null and !queueEntries.empty}">
      <thead>
      <tr>
        <th>Book Title</th>
        <th>Request Date</th>
        <th>Action</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="entry : ${queueEntries}">
        <td>
          <a th:href="@{/titles/view/{id}(id=${entry.title.id})}"
             th:text="${entry.title.titleName}"
             style="font-weight: bold; color: #007bff; text-decoration: none;">Title</a>
        </td>
        <td th:text="${#temporals.format(entry.requestDate, 'yyyy-MM-dd HH:mm')}">2026-01-01 12:00</td>
        <td>
          <form th:action="@{/queue/web/admin/remove}" method="post" onsubmit="return confirm('Remove this user from the queue?');">
            <input type="hidden" name="userId" th:value="${user.id}" />
            <input type="hidden" name="titleId" th:value="${entry.title.id}" />
            <button type="submit" class="btn btn-danger btn-sm">Remove</button>
          </form>
        </td>
      </tr>
      </tbody>
    </table>
  </div>

</div>

</body>
</html>